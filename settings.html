<div id="carrot_settings" class="carrot-extension-settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>ü•ï CarrotKernel</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            
            <!-- Feature Controls -->
            <div class="carrot-card carrot-enable-card carrot-tutorial-target" id="carrot-feature-controls"
                 data-tutorial-step="feature-controls"
                 data-tooltip="Master controls for CarrotKernel functionality">
                <div class="carrot-card-header">
                    <h3>‚ö° Feature Controls</h3>
                    <p class="carrot-card-subtitle">Character consistency tracking system</p>
                </div>
                <div class="carrot-card-body">
                    <div class="carrot-settings-grid">
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_enabled" checked>
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Master Enable</span>
                            </label>
                            <div class="carrot-help-text">Enable/disable CarrotKernel character tracking</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_send_to_ai" checked>
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">AI Injection</span>
                            </label>
                            <div class="carrot-help-text">Send character data to AI context for consistency</div>
                        </div>
                        <div class="carrot-setting-item">
                            <select id="carrot_display_mode" class="carrot-select">
                                <option value="none">No Display</option>
                                <option value="thinking">Thinking Box Style</option>
                                <option value="cards">Character Cards</option>
                            </select>
                            <div class="carrot-help-text">Choose how character data appears in chat</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_auto_expand">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Auto-expand thinking boxes</span>
                            </label>
                            <div class="carrot-help-text">Automatically expand thinking boxes when displayed</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_debug_mode">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Debug Mode</span>
                            </label>
                            <div class="carrot-help-text">Enable detailed console logging</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_baby_bunny_mode">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">üê∞ Baby Bunny Mode</span>
                            </label>
                            <div class="carrot-help-text">Guided automation for sheet processing and character archive creation</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_worldbook_tracker">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">üåç WorldBook Tracker</span>
                            </label>
                            <div class="carrot-help-text">Show WorldBook Tracker icon and panel for monitoring active lorebook entries</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_auto_rescan" checked>
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">üîÑ Auto-rescan on chat load</span>
                            </label>
                            <div class="carrot-help-text">Automatically re-scan character repos when switching chats to restore tag display</div>
                        </div>
                        <div class="carrot-setting-item carrot-slider-container">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">üë•</span>
                                <span class="carrot-slider-title">Max Characters Displayed: <span id="carrot_max_display_value">6</span></span>
                            </div>
                            <div class="carrot-slider-hint">Limit characters shown in chat to prevent visual clutter</div>
                            <input type="range" id="carrot_max_characters_display" class="carrot-slider" min="1" max="20" value="6">
                        </div>
                        <div class="carrot-setting-item carrot-slider-container">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">üíâ</span>
                                <span class="carrot-slider-title">Max Characters Injected: <span id="carrot_max_inject_value">6</span></span>
                            </div>
                            <div class="carrot-slider-hint">Limit characters sent to AI context to save tokens</div>
                            <input type="range" id="carrot_max_characters_inject" class="carrot-slider" min="1" max="20" value="6">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Panels -->
            <div class="carrot-status-section">
                <div class="carrot-status-panels">
                    <div class="carrot-status-panel carrot-status-system carrot-clickable" 
                         data-tooltip="Click to open System Tutorial - Learn how to configure CarrotKernel settings"
                         onclick="CarrotKernel.openSystemTutorial()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-microchip"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">System Status</div>
                            <div class="carrot-status-value" id="carrot-system-status">Initializing...</div>
                            <div class="carrot-status-detail" id="carrot-system-detail">Click to open tutorial</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-system-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                    </div>
                    
                    <div class="carrot-status-panel carrot-status-repository carrot-clickable" 
                         data-tooltip="Click to manually scan repositories - Or learn about character indexing"
                         onclick="CarrotKernel.openRepositoryManager()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-database"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">Character Repository</div>
                            <div class="carrot-status-value" id="carrot-repo-status">0 characters indexed</div>
                            <div class="carrot-status-detail" id="carrot-repo-detail">Click to manage repositories</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-repo-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                    </div>
                    
                    <div class="carrot-status-panel carrot-status-injection carrot-clickable" 
                         data-tooltip="Click to learn about AI injection - How character data gets sent to AI context"
                         onclick="CarrotKernel.openInjectionTutorial()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-syringe"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">AI Injection</div>
                            <div class="carrot-status-value" id="carrot-injection-status">Standby</div>
                            <div class="carrot-status-detail" id="carrot-injection-detail">Click to learn about injection</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-injection-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                        <div class="carrot-hover-tooltip" id="carrot-injection-tooltip">
                            <div class="carrot-tooltip-header">
                                <i class="fa-solid fa-info-circle"></i>
                                <strong>AI Injection System</strong>
                            </div>
                            <div class="carrot-tooltip-content">
                                <p><strong>How it works:</strong></p>
                                <ul>
                                    <li>Detects character mentions in your messages</li>
                                    <li>Injects relevant character data at depth 4</li>
                                    <li>Uses ST's native /inject command for consistency</li>
                                    <li>Ephemeral injections don't clutter chat history</li>
                                </ul>
                                <p><strong>Current Status:</strong> <span id="carrot-injection-tooltip-status">Ready</span></p>
                                <div class="carrot-tooltip-example">
                                    <strong>Example injection:</strong>
                                    <code>&lt;NAME:Alice&gt;, &lt;SPECIES:Human&gt;, &lt;PERSONALITY:Shy&gt;</code>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="carrot-status-panel carrot-status-templates carrot-clickable" 
                         data-tooltip="Click to manage prompt templates - Create custom injection templates with variable control"
                         onclick="CarrotKernel.openTemplateManager()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-file-code"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">Template Manager</div>
                            <div class="carrot-status-value" id="carrot-template-status">Default template</div>
                            <div class="carrot-status-detail" id="carrot-template-detail">Click to manage templates</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-template-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                    </div>
                    
                    <div class="carrot-status-panel carrot-status-packs carrot-clickable" 
                         data-tooltip="Click to manage BunnyMo pack installation and updates - Main pack, themes, and expansions"
                         onclick="CarrotKernel.openPackManager()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-cube"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">Pack Manager</div>
                            <div class="carrot-status-value" id="carrot-pack-status">Scanning packs...</div>
                            <div class="carrot-status-detail" id="carrot-pack-detail">Click to manage BunnyMo packs</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-pack-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lorebook Management -->
            <div class="carrot-card carrot-tutorial-target" id="carrot-lorebook-management"
                 data-tutorial-step="lorebook-management"
                 data-tooltip="Select and configure character repositories from your lorebooks">
                <div class="carrot-card-header">
                    <h3>üìö Lorebook Management</h3>
                    <p class="carrot-card-subtitle">Configure character repositories and tag libraries</p>
                </div>
                <div class="carrot-card-body">
                    <div class="carrot-search-container">
                        <input type="text" id="carrot-search-lorebooks" class="carrot-search-input" placeholder="üîç Search lorebooks...">
                    </div>
                    <div class="carrot-lorebook-container">
                        <div class="carrot-lorebook-list" id="carrot-lorebook-list">
                            <div class="carrot-loading-state">
                                <div class="carrot-spinner"></div>
                                <p>Loading available lorebooks...</p>
                            </div>
                        </div>
                    </div>
                    <div class="carrot-action-bar">
                        <button id="carrot-scan-btn" class="carrot-primary-btn">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            Scan Selected Lorebooks
                        </button>
                        <button id="carrot-test-display" class="carrot-secondary-btn">
                            <i class="fa-solid fa-eye"></i>
                            Test Display
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tutorial Picker Section -->
            <div class="carrot-help-section">
                <div class="carrot-help-header">
                    <h4>üí° Need Help?</h4>
                    <p class="carrot-help-subtitle">Click any tutorial below to learn how to use CarrotKernel</p>
                </div>

                <div class="carrot-tutorial-grid">
                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openSystemTutorial()">
                        <div class="carrot-tutorial-number">1</div>
                        <div class="carrot-tutorial-content">
                            <strong>System Setup</strong>
                            <span>Learn basic configuration and how to enable CarrotKernel</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openRepositoryTutorial()">
                        <div class="carrot-tutorial-number">2</div>
                        <div class="carrot-tutorial-content">
                            <strong>Character Repository</strong>
                            <span>Scan lorebooks and manage your character data</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openInjectionTutorial()">
                        <div class="carrot-tutorial-number">3</div>
                        <div class="carrot-tutorial-content">
                            <strong>AI Injection</strong>
                            <span>Understand how character data reaches your AI</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openLoadoutTutorial()">
                        <div class="carrot-tutorial-number">4</div>
                        <div class="carrot-tutorial-content">
                            <strong>Loadout Manager</strong>
                            <span>Create context-specific settings for characters and chats</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openTemplateEditorTutorial()">
                        <div class="carrot-tutorial-number">5</div>
                        <div class="carrot-tutorial-content">
                            <strong>Template Editor</strong>
                            <span>Customize how character data is formatted for AI</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openBabyBunnyTutorial()">
                        <div class="carrot-tutorial-number">6</div>
                        <div class="carrot-tutorial-content">
                            <strong>Baby Bunny Mode</strong>
                            <span>Create character archives from AI-generated sheets</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>
                </div>

                <div class="carrot-format-example">
                    <div class="carrot-format-header">
                        <i class="fa-solid fa-code"></i>
                        <strong>Character Repository Format Example</strong>
                    </div>
                    <div class="carrot-format-code">
                        <code>&lt;BunnymoTags&gt;&lt;Name:Atsu_Ibn_Oba_Al-Masri&gt;, &lt;GENRE:FANTASY&gt; &lt;PHYSICAL&gt; &lt;SPECIES:HUMAN&gt;, &lt;GENDER:MALE&gt;, &lt;BUILD:Muscular&gt;, &lt;BUILD:Tall&gt;, &lt;SKIN:FAIR&gt;, &lt;HAIR:BLACK&gt;, &lt;STYLE:ANCIENT_EGYPTIAN_ROYALTY&gt;,&lt;/PHYSICAL&gt; &lt;PERSONALITY&gt;&lt;Dere:Sadodere&gt;, &lt;Dere:Oujidere&gt;, &lt;ENTJ-U&gt;, &lt;TRAIT:CRUEL&gt;, &lt;TRAIT:INTELLIGENT&gt;, &lt;TRAIT:POWERFUL&gt;, &lt;TRAIT:DANGEROUS&gt;, &lt;TRAIT:SELFISH&gt;, &lt;TRAIT:HEDONISTIC&gt;, &lt;ATTACHMENT:FEARFUL_AVOIDANT&gt;, &lt;CONFLICT:COMPETITIVE&gt;, &lt;BOUNDARIES:RIGID&gt;,&lt;FLIRTING:AGGRESSIVE&gt;, &lt;/PERSONALITY&gt; &lt;NSFW&gt;&lt;ORIENTATION:PANSEXUAL&gt;, &lt;POWER:DOMINANT&gt;, &lt;KINK:BRAT_TAMING&gt;, &lt;KINK:PUBLIC_HUMILIATION&gt;, &lt;KINK:POWER_PLAY&gt;, &lt;KINK:EXHIBITIONISM&gt;, &lt;CHEMISTRY:ANTAGONISTIC&gt;, &lt;AROUSAL:DOMINANCE&gt;, &lt;TRAUMA:CHILDHOOD&gt;, &lt;JEALOUSY:POSSESSIVE&gt;,&lt;/NSFW&gt;

 &lt;Genre&gt; This story primarily uses &lt;GENRE:BLANK&gt; as its most prominent narrative foundation, establishing the core structure and pacing. This is often blended with &lt;GENRE:ROMANCE&gt; as a secondary layer, adding emotional stakes and relationship development to the primary genre framework. &lt;/Genre&gt;

&lt;Linguistics&gt; Character uses &lt;LING:COMMANDING&gt; as his primary mode of speech, asserting authority and control. This is almost always blended with &lt;LING:SUGGESTIVE&gt;, using a tone of cruel flirtation, possessive pet names, and psychological manipulation to achieve his goals. &lt;/linguistics&gt;&lt;/BunnymoTags&gt;</code>
                    </div>
                    <div class="carrot-format-note">
                        <i class="fa-solid fa-lightbulb"></i>
                        <span>Place these blocks in your lorebook entries to create character repositories</span>
                    </div>
                </div>
            </div>
            
            <!-- Popup Overlays -->
            <div class="carrot-popup-overlay" id="carrot-popup-overlay" style="display: none;">
                <div class="carrot-popup-container" id="carrot-popup-container">
                    <!-- Dynamic popup content will be inserted here -->
                </div>
            </div>
            
            <!-- Tutorial Overlay -->
            <div class="carrot-tutorial-overlay" id="carrot-tutorial-overlay" style="display: none;">
                <div class="carrot-tutorial-spotlight" id="carrot-tutorial-spotlight"></div>
                <div class="carrot-tutorial-popup" id="carrot-tutorial-popup">
                    <div class="carrot-tutorial-popup-header">
                        <h4 id="carrot-tutorial-popup-title">Tutorial Step</h4>
                        <button class="carrot-tutorial-close" onclick="CarrotKernel.closeTutorial()">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="carrot-tutorial-popup-content" id="carrot-tutorial-popup-content">
                        <!-- Tutorial content -->
                    </div>
                    <div class="carrot-tutorial-popup-nav">
                        <button class="carrot-tutorial-prev" id="carrot-tutorial-prev" onclick="CarrotKernel.previousTutorialStep()">
                            <i class="fa-solid fa-arrow-left"></i> Previous
                        </button>
                        <span class="carrot-tutorial-progress" id="carrot-tutorial-progress">1 / 5</span>
                        <button class="carrot-tutorial-next" id="carrot-tutorial-next" onclick="CarrotKernel.nextTutorialStep()">
                            Next <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>


            </div>
        </div>
    </div>
</div>