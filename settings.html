<div id="carrot_settings" class="carrot-extension-settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>ü•ï CarrotKernel</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            
            <!-- Feature Controls -->
            <div class="carrot-card carrot-enable-card carrot-tutorial-target" id="carrot-feature-controls"
                 data-tutorial-step="feature-controls"
                 data-tooltip="Master controls for CarrotKernel functionality">
                <div class="carrot-card-header">
                    <h3>‚ö° Feature Controls</h3>
                    <p class="carrot-card-subtitle">Character consistency tracking system</p>
                </div>
                <div class="carrot-card-body">
                    <div class="carrot-settings-grid">
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_enabled" checked>
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Master Enable</span>
                            </label>
                            <div class="carrot-help-text">Enable/disable CarrotKernel character tracking</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_send_to_ai" checked>
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">AI Injection</span>
                            </label>
                            <div class="carrot-help-text">Send character data to AI context for consistency</div>
                        </div>
                        <div class="carrot-setting-item">
                            <select id="carrot_display_mode" class="carrot-select">
                                <option value="none">No Display</option>
                                <option value="thinking">Thinking Box Style</option>
                                <option value="cards">Character Cards</option>
                            </select>
                            <div class="carrot-help-text">Choose how character data appears in chat</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_auto_expand">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Auto-expand thinking boxes</span>
                            </label>
                            <div class="carrot-help-text">Automatically expand thinking boxes when displayed</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_debug_mode">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Debug Mode</span>
                            </label>
                            <div class="carrot-help-text">Enable detailed console logging</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_baby_bunny_mode">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">üê∞ Baby Bunny Mode</span>
                            </label>
                            <div class="carrot-help-text">Guided automation for sheet processing and character archive creation</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_worldbook_tracker">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">üåç WorldBook Tracker</span>
                            </label>
                            <div class="carrot-help-text">Show WorldBook Tracker icon and panel for monitoring active lorebook entries</div>
                        </div>
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_auto_rescan" checked>
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">üîÑ Auto-rescan on chat load</span>
                            </label>
                            <div class="carrot-help-text">Automatically re-scan character repos when switching chats to restore tag display</div>
                        </div>
                        <div class="carrot-setting-item carrot-slider-container">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">üë•</span>
                                <span class="carrot-slider-title">Max Characters Displayed: <span id="carrot_max_display_value">6</span></span>
                            </div>
                            <div class="carrot-slider-hint">Limit characters shown in chat to prevent visual clutter</div>
                            <input type="range" id="carrot_max_characters_display" class="carrot-slider" min="1" max="20" value="6">
                        </div>
                        <div class="carrot-setting-item carrot-slider-container">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">üíâ</span>
                                <span class="carrot-slider-title">Max Characters Injected: <span id="carrot_max_inject_value">6</span></span>
                            </div>
                            <div class="carrot-slider-hint">Limit characters sent to AI context to save tokens</div>
                            <input type="range" id="carrot_max_characters_inject" class="carrot-slider" min="1" max="20" value="6">
                        </div>
                    </div>
                </div>
            </div>

            <!-- RAG System (Experimental) -->
            <div class="carrot-card carrot-tutorial-target inline-drawer" id="carrot-rag-settings"
                 data-tutorial-step="rag-settings"
                 data-tooltip="Experimental RAG system for fullsheet vectorization">
                <div class="inline-drawer-toggle inline-drawer-header carrot-card-header" style="cursor: pointer;">
                    <div>
                        <h3 style="margin: 0;">
                            üî¨ Smart Context (RAG)
                            <span class="carrot-experimental-badge">EXPERIMENTAL</span>
                        </h3>
                        <p class="carrot-card-subtitle" style="margin: 0;">Inject only relevant parts of fullsheets instead of everything</p>
                    </div>
                    <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                </div>
                <div class="inline-drawer-content carrot-card-body">
                    <div class="carrot-settings-grid">
                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_rag_enabled">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Enable Smart Context</span>
                            </label>
                            <div class="carrot-help-text">Send only relevant fullsheet sections instead of the entire sheet (saves 80-90% context)</div>
                        </div>

                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_rag_auto_vectorize" checked>
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Auto-save fullsheets</span>
                            </label>
                            <div class="carrot-help-text">Automatically save fullsheets when AI generates them</div>
                        </div>

                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_rag_debug_mode">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Show what's being sent</span>
                            </label>
                            <div class="carrot-help-text">Display full injection text in browser console</div>
                        </div>

                        <div class="carrot-setting-item">
                            <select id="carrot_rag_context_level" class="carrot-select">
                                <option value="global">Global Storage (All characters/chats)</option>
                                <option value="character">Character Storage (This character only)</option>
                                <option value="chat">Chat Storage (This chat only)</option>
                            </select>
                            <div class="carrot-help-text">Where to store fullsheet data - Global shares across all chats, Character is per-character, Chat is per-conversation</div>
                        </div>

                        <div class="carrot-setting-item">
                            <select id="carrot_rag_role" class="carrot-select">
                                <option value="system">System</option>
                                <option value="user">User</option>
                                <option value="assistant">Assistant</option>
                            </select>
                            <div class="carrot-help-text">How to label injected sections (System = instruction, User = conversation)</div>
                        </div>

                        <div class="carrot-setting-item">
                            <label class="carrot-toggle">
                                <input type="checkbox" id="carrot_rag_simple_chunking">
                                <span class="carrot-toggle-slider"></span>
                                <span class="carrot-toggle-label">Simple section-based chunking</span>
                            </label>
                            <div class="carrot-help-text">Split fullsheets by section headers only (e.g., "Boundary Architecture" = one chunk). Disables complex size/overlap settings.</div>
                        </div>

                        <div class="carrot-setting-item carrot-slider-container" id="carrot-rag-complex-settings">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">üìÑ</span>
                                <span class="carrot-slider-title">Sections to send: <span id="carrot_rag_topk_value">3</span></span>
                            </div>
                            <div class="carrot-slider-hint">How many relevant sections to inject (3 = ~3000 chars, 5 = ~5000 chars)</div>
                            <input type="range" id="carrot_rag_topk" class="carrot-slider" min="1" max="10" value="3">
                        </div>

                        <div class="carrot-setting-item carrot-slider-container">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">üéØ</span>
                                <span class="carrot-slider-title">Relevance filter: <span id="carrot_rag_threshold_value">0.15</span></span>
                            </div>
                            <div class="carrot-slider-hint">How closely sections must match your message (lower = more permissive)</div>
                            <input type="range" id="carrot_rag_threshold" class="carrot-slider" min="0" max="100" value="15" step="5">
                        </div>

                        <div class="carrot-setting-item carrot-slider-container">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">üí¨</span>
                                <span class="carrot-slider-title">Consider last <span id="carrot_rag_context_value">3</span> messages</span>
                            </div>
                            <div class="carrot-slider-hint">How many recent messages to analyze for finding relevant sections</div>
                            <input type="range" id="carrot_rag_context" class="carrot-slider" min="1" max="10" value="3">
                        </div>

                        <div class="carrot-setting-item carrot-slider-container carrot-complex-setting">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">‚úÇÔ∏è</span>
                                <span class="carrot-slider-title">Section size: <span id="carrot_rag_chunksize_value">1000</span> chars</span>
                            </div>
                            <div class="carrot-slider-hint">How large each section should be when splitting fullsheets</div>
                            <input type="range" id="carrot_rag_chunksize" class="carrot-slider" min="600" max="2000" value="1000" step="100">
                        </div>

                        <div class="carrot-setting-item carrot-slider-container carrot-complex-setting">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">üîó</span>
                                <span class="carrot-slider-title">Section overlap: <span id="carrot_rag_overlap_value">300</span> chars</span>
                            </div>
                            <div class="carrot-slider-hint">How much sections should overlap (higher = better context bridging)</div>
                            <input type="range" id="carrot_rag_overlap" class="carrot-slider" min="0" max="600" value="300" step="50">
                        </div>

                        <div class="carrot-setting-item carrot-slider-container">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">üíâ</span>
                                <span class="carrot-slider-title">Context depth: <span id="carrot_rag_depth_value">4</span></span>
                            </div>
                            <div class="carrot-slider-hint">Where in AI context to inject (4 = standard, higher = deeper in memory)</div>
                            <input type="range" id="carrot_rag_depth" class="carrot-slider" min="1" max="10" value="4">
                        </div>

                        <div class="carrot-setting-item carrot-slider-container">
                            <div class="carrot-slider-header">
                                <span class="carrot-slider-icon">dY"X</span>
                                <span class="carrot-slider-title">Crosslink sensitivity: <span id="carrot_rag_crosslink_value">0.25</span></span>
                            </div>
                            <div class="carrot-slider-hint">Pull related sections when themes overlap (higher = more aggressive linking)</div>
                            <input type="range" id="carrot_rag_crosslink" class="carrot-slider" min="0" max="100" value="25" step="5">
                        </div>
                    </div>

                    <div class="carrot-action-bar">
                        <button id="carrot-rag-vectorize-btn" class="carrot-primary-btn">
                            <i class="fa-solid fa-cube"></i>
                            Save All Fullsheets in Chat
                        </button>
                        <button id="carrot-rag-clear-collections-btn" class="carrot-danger-btn">
                            <i class="fa-solid fa-trash"></i>
                            Delete All Saved Data
                        </button>
                    </div>

                    <!-- RAG Data Viewer -->
                    <div class="inline-drawer" style="margin-top: 24px;">
                        <div class="inline-drawer-toggle inline-drawer-header" style="padding: 14px 18px; background: var(--black30a, rgba(0,0,0,0.3)); border: 1px solid var(--SmartThemeBorderColor, rgba(255,255,255,0.1)); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <strong style="color: var(--SmartThemeEmColor, white); display: flex; align-items: center; gap: 8px; font-size: 1.05em;">
                                <i class="fa-solid fa-database" style="color: var(--SmartThemeQuoteColor, #10b981);"></i>
                                Saved Data Viewer
                            </strong>
                            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                        </div>
                        <div class="inline-drawer-content" style="padding: 20px; background: var(--black30a, rgba(0,0,0,0.2)); border: 1px solid var(--SmartThemeBorderColor, rgba(255,255,255,0.1)); border-top: none; border-radius: 0 0 8px 8px; margin-top: -1px;">
                            <div id="carrot-rag-collections-viewer">
                                <!-- Storage Level Selector -->
                                <div class="carrot-setting-item" style="margin-bottom: 16px;">
                                    <label class="carrot-label">
                                        <span class="carrot-label-text" style="display: flex; align-items: center; gap: 6px;">
                                            <i class="fa-solid fa-layer-group"></i>
                                            Storage Level
                                        </span>
                                        <span class="carrot-label-hint">Select which storage to view: Global (all), Character (per-character), or Chat (current chat only)</span>
                                    </label>
                                    <select id="carrot_rag_viewer_context" class="carrot-select">
                                        <option value="global">üåç Global Storage (All characters/chats)</option>
                                        <option value="character">üë§ Character Storage (Current character)</option>
                                        <option value="chat">üí¨ Chat Storage (Current chat)</option>
                                    </select>
                                </div>

                                <!-- Refresh Button -->
                                <div style="display: flex; justify-content: center; margin-bottom: 16px;">
                                    <button id="carrot-rag-refresh-viewer" class="carrot-secondary-btn">
                                        <i class="fa-solid fa-refresh"></i>
                                        Refresh Data
                                    </button>
                                </div>

                                <!-- Collections List (dynamically populated) -->
                                <div id="carrot-rag-collections-list" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--SmartThemeBorderColor, rgba(255,255,255,0.1));">
                                    <!-- Collections will be dynamically populated here by JavaScript -->
                                </div>

                                <!-- Empty State -->
                                <div id="carrot-rag-empty-state" style="
                                    text-align: center;
                                    padding: 32px 24px;
                                    color: var(--grey70, #94a3b8);
                                    background: var(--SmartThemeBlurTintColor, rgba(0,0,0,0.2));
                                    border-radius: 8px;
                                    border: 1px dashed var(--SmartThemeBorderColor, rgba(255,255,255,0.1));
                                ">
                                    <i class="fa-solid fa-database" style="font-size: 2.5em; opacity: 0.3; margin-bottom: 12px; display: block;"></i>
                                    <p style="margin: 0 0 8px; font-size: 1.1em; color: var(--SmartThemeEmColor, white);">No Saved Data</p>
                                    <p style="margin: 0; font-size: 0.95em; line-height: 1.6;">
                                        Click "Save All Fullsheets in Chat" above to start saving fullsheet data,<br>
                                        or enable "Auto-save fullsheets" for automatic saving.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="inline-drawer" style="margin-top: 20px;">
                        <div class="inline-drawer-toggle inline-drawer-header" style="padding: 12px; background: color-mix(in srgb, #3b82f6 10%, transparent); border-radius: 6px; cursor: pointer;">
                            <strong><i class="fa-solid fa-lightbulb"></i> How Smart Context Works</strong>
                            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
                        </div>
                        <div class="inline-drawer-content carrot-rag-tutorial">
                        <div class="carrot-tutorial-section">
                            <h4><i class="fa-solid fa-lightbulb"></i> What is Smart Context?</h4>
                            <p>
                                Instead of sending the AI your entire 15,000+ character fullsheet every message, Smart Context only sends
                                the 3-5 most relevant sections based on what you're talking about. This saves 80-90% of your context window!
                            </p>
                            <ul>
                                <li><strong>Automatic:</strong> When AI generates a fullsheet, it's automatically split into sections and saved</li>
                                <li><strong>Smart Matching:</strong> Your recent messages are analyzed to find what's relevant</li>
                                <li><strong>Related Sections:</strong> If "flirting" section mentions "trauma", trauma section is also retrieved</li>
                                <li><strong>Per-Character:</strong> Each character's data is stored separately (no mixing Atsu with Ahmosi!)</li>
                            </ul>

                            <h4><i class="fa-solid fa-cog"></i> Quick Settings Guide</h4>
                            <ul>
                                <li><strong>Sections to send:</strong> 3 = ~3000 chars (balanced), 5 = ~5000 chars (detailed)</li>
                                <li><strong>Relevance filter:</strong> 0.15 = permissive (recommended), 0.30 = strict, 0.05 = very loose</li>
                                <li><strong>Consider last X messages:</strong> 3 = recent focus, 5-7 = broader conversation context</li>
                                <li><strong>Section overlap:</strong> 300 = good bridging (recommended), 500 = better but more data</li>
                            </ul>

                            <h4><i class="fa-solid fa-flask"></i> Experimental Feature</h4>
                            <p class="carrot-warning-text">
                                <i class="fa-solid fa-exclamation-triangle"></i>
                                This is experimental! Test it first in a practice chat. Sometimes the AI might miss details if your
                                message doesn't semantically match the fullsheet sections. You can always click "Show what's being sent" to debug.
                            </p>
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Panels -->
            <div class="carrot-status-section">
                <div class="carrot-status-panels">
                    <div class="carrot-status-panel carrot-status-system carrot-clickable" 
                         data-tooltip="Click to open System Tutorial - Learn how to configure CarrotKernel settings"
                         onclick="CarrotKernel.openSystemTutorial()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-microchip"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">System Status</div>
                            <div class="carrot-status-value" id="carrot-system-status">Initializing...</div>
                            <div class="carrot-status-detail" id="carrot-system-detail">Click to open tutorial</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-system-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                    </div>
                    
                    <div class="carrot-status-panel carrot-status-repository carrot-clickable" 
                         data-tooltip="Click to manually scan repositories - Or learn about character indexing"
                         onclick="CarrotKernel.openRepositoryManager()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-database"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">Character Repository</div>
                            <div class="carrot-status-value" id="carrot-repo-status">0 characters indexed</div>
                            <div class="carrot-status-detail" id="carrot-repo-detail">Click to manage repositories</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-repo-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                    </div>
                    
                    <div class="carrot-status-panel carrot-status-injection carrot-clickable" 
                         data-tooltip="Click to learn about AI injection - How character data gets sent to AI context"
                         onclick="CarrotKernel.openInjectionTutorial()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-syringe"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">AI Injection</div>
                            <div class="carrot-status-value" id="carrot-injection-status">Standby</div>
                            <div class="carrot-status-detail" id="carrot-injection-detail">Click to learn about injection</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-injection-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                        <div class="carrot-hover-tooltip" id="carrot-injection-tooltip">
                            <div class="carrot-tooltip-header">
                                <i class="fa-solid fa-info-circle"></i>
                                <strong>AI Injection System</strong>
                            </div>
                            <div class="carrot-tooltip-content">
                                <p><strong>How it works:</strong></p>
                                <ul>
                                    <li>Detects character mentions in your messages</li>
                                    <li>Injects relevant character data at depth 4</li>
                                    <li>Uses ST's native /inject command for consistency</li>
                                    <li>Ephemeral injections don't clutter chat history</li>
                                </ul>
                                <p><strong>Current Status:</strong> <span id="carrot-injection-tooltip-status">Ready</span></p>
                                <div class="carrot-tooltip-example">
                                    <strong>Example injection:</strong>
                                    <code>&lt;NAME:Alice&gt;, &lt;SPECIES:Human&gt;, &lt;PERSONALITY:Shy&gt;</code>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="carrot-status-panel carrot-status-templates carrot-clickable" 
                         data-tooltip="Click to manage prompt templates - Create custom injection templates with variable control"
                         onclick="CarrotKernel.openTemplateManager()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-file-code"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">Template Manager</div>
                            <div class="carrot-status-value" id="carrot-template-status">Default template</div>
                            <div class="carrot-status-detail" id="carrot-template-detail">Click to manage templates</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-template-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                    </div>
                    
                    <div class="carrot-status-panel carrot-status-packs carrot-clickable" 
                         data-tooltip="Click to manage BunnyMo pack installation and updates - Main pack, themes, and expansions"
                         onclick="CarrotKernel.openPackManager()">
                        <div class="carrot-status-icon">
                            <i class="fa-solid fa-cube"></i>
                        </div>
                        <div class="carrot-status-content">
                            <div class="carrot-status-title">Pack Manager</div>
                            <div class="carrot-status-value" id="carrot-pack-status">Scanning packs...</div>
                            <div class="carrot-status-detail" id="carrot-pack-detail">Click to manage BunnyMo packs</div>
                        </div>
                        <div class="carrot-status-indicator" id="carrot-pack-indicator">
                            <div class="carrot-pulse-dot"></div>
                        </div>
                        <div class="carrot-click-hint">
                            <i class="fa-solid fa-mouse-pointer"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lorebook Management -->
            <div class="carrot-card carrot-tutorial-target" id="carrot-lorebook-management"
                 data-tutorial-step="lorebook-management"
                 data-tooltip="Select and configure character repositories from your lorebooks">
                <div class="carrot-card-header">
                    <h3>üìö Lorebook Management</h3>
                    <p class="carrot-card-subtitle">Configure character repositories and tag libraries</p>
                </div>
                <div class="carrot-card-body">
                    <div class="carrot-search-container">
                        <input type="text" id="carrot-search-lorebooks" class="carrot-search-input" placeholder="üîç Search lorebooks...">
                    </div>
                    <div class="carrot-lorebook-container">
                        <div class="carrot-lorebook-list" id="carrot-lorebook-list">
                            <div class="carrot-loading-state">
                                <div class="carrot-spinner"></div>
                                <p>Loading available lorebooks...</p>
                            </div>
                        </div>
                    </div>
                    <div class="carrot-action-bar">
                        <button id="carrot-scan-btn" class="carrot-primary-btn">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            Scan Selected Lorebooks
                        </button>
                        <button id="carrot-test-display" class="carrot-secondary-btn">
                            <i class="fa-solid fa-eye"></i>
                            Test Display
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tutorial Picker Section -->
            <div class="carrot-help-section">
                <div class="carrot-help-header">
                    <h4>üí° Need Help?</h4>
                    <p class="carrot-help-subtitle">Click any tutorial below to learn how to use CarrotKernel</p>
                </div>

                <div class="carrot-tutorial-grid">
                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openSystemTutorial()">
                        <div class="carrot-tutorial-number">1</div>
                        <div class="carrot-tutorial-content">
                            <strong>System Setup</strong>
                            <span>Learn basic configuration and how to enable CarrotKernel</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openRepositoryTutorial()">
                        <div class="carrot-tutorial-number">2</div>
                        <div class="carrot-tutorial-content">
                            <strong>Character Repository</strong>
                            <span>Scan lorebooks and manage your character data</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openInjectionTutorial()">
                        <div class="carrot-tutorial-number">3</div>
                        <div class="carrot-tutorial-content">
                            <strong>AI Injection</strong>
                            <span>Understand how character data reaches your AI</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openLoadoutTutorial()">
                        <div class="carrot-tutorial-number">4</div>
                        <div class="carrot-tutorial-content">
                            <strong>Loadout Manager</strong>
                            <span>Create context-specific settings for characters and chats</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openTemplateEditorTutorial()">
                        <div class="carrot-tutorial-number">5</div>
                        <div class="carrot-tutorial-content">
                            <strong>Template Editor</strong>
                            <span>Customize how character data is formatted for AI</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>

                    <div class="carrot-tutorial-card" onclick="CarrotKernel.openBabyBunnyTutorial()">
                        <div class="carrot-tutorial-number">6</div>
                        <div class="carrot-tutorial-content">
                            <strong>Baby Bunny Mode</strong>
                            <span>Create character archives from AI-generated sheets</span>
                        </div>
                        <div class="carrot-tutorial-arrow">‚Üí</div>
                    </div>
                </div>

                <div class="carrot-format-example">
                    <div class="carrot-format-header">
                        <i class="fa-solid fa-code"></i>
                        <strong>Character Repository Format Example</strong>
                    </div>
                    <div class="carrot-format-code">
                        <code>&lt;BunnymoTags&gt;&lt;Name:Atsu_Ibn_Oba_Al-Masri&gt;, &lt;GENRE:FANTASY&gt; &lt;PHYSICAL&gt; &lt;SPECIES:HUMAN&gt;, &lt;GENDER:MALE&gt;, &lt;BUILD:Muscular&gt;, &lt;BUILD:Tall&gt;, &lt;SKIN:FAIR&gt;, &lt;HAIR:BLACK&gt;, &lt;STYLE:ANCIENT_EGYPTIAN_ROYALTY&gt;,&lt;/PHYSICAL&gt; &lt;PERSONALITY&gt;&lt;Dere:Sadodere&gt;, &lt;Dere:Oujidere&gt;, &lt;ENTJ-U&gt;, &lt;TRAIT:CRUEL&gt;, &lt;TRAIT:INTELLIGENT&gt;, &lt;TRAIT:POWERFUL&gt;, &lt;TRAIT:DANGEROUS&gt;, &lt;TRAIT:SELFISH&gt;, &lt;TRAIT:HEDONISTIC&gt;, &lt;ATTACHMENT:FEARFUL_AVOIDANT&gt;, &lt;CONFLICT:COMPETITIVE&gt;, &lt;BOUNDARIES:RIGID&gt;,&lt;FLIRTING:AGGRESSIVE&gt;, &lt;/PERSONALITY&gt; &lt;NSFW&gt;&lt;ORIENTATION:PANSEXUAL&gt;, &lt;POWER:DOMINANT&gt;, &lt;KINK:BRAT_TAMING&gt;, &lt;KINK:PUBLIC_HUMILIATION&gt;, &lt;KINK:POWER_PLAY&gt;, &lt;KINK:EXHIBITIONISM&gt;, &lt;CHEMISTRY:ANTAGONISTIC&gt;, &lt;AROUSAL:DOMINANCE&gt;, &lt;TRAUMA:CHILDHOOD&gt;, &lt;JEALOUSY:POSSESSIVE&gt;,&lt;/NSFW&gt;

 &lt;Genre&gt; This story primarily uses &lt;GENRE:BLANK&gt; as its most prominent narrative foundation, establishing the core structure and pacing. This is often blended with &lt;GENRE:ROMANCE&gt; as a secondary layer, adding emotional stakes and relationship development to the primary genre framework. &lt;/Genre&gt;

&lt;Linguistics&gt; Character uses &lt;LING:COMMANDING&gt; as his primary mode of speech, asserting authority and control. This is almost always blended with &lt;LING:SUGGESTIVE&gt;, using a tone of cruel flirtation, possessive pet names, and psychological manipulation to achieve his goals. &lt;/linguistics&gt;&lt;/BunnymoTags&gt;</code>
                    </div>
                    <div class="carrot-format-note">
                        <i class="fa-solid fa-lightbulb"></i>
                        <span>Place these blocks in your lorebook entries to create character repositories</span>
                    </div>
                </div>
            </div>
            
            <!-- Popup Overlays -->
            <div class="carrot-popup-overlay" id="carrot-popup-overlay" style="display: none;">
                <div class="carrot-popup-container" id="carrot-popup-container">
                    <!-- Dynamic popup content will be inserted here -->
                </div>
            </div>
            
            <!-- Tutorial Overlay -->
            <div class="carrot-tutorial-overlay" id="carrot-tutorial-overlay" style="display: none;">
                <div class="carrot-tutorial-spotlight" id="carrot-tutorial-spotlight"></div>
                <div class="carrot-tutorial-popup" id="carrot-tutorial-popup">
                    <div class="carrot-tutorial-popup-header">
                        <h4 id="carrot-tutorial-popup-title">Tutorial Step</h4>
                        <button class="carrot-tutorial-close" onclick="CarrotKernel.closeTutorial()">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                    <div class="carrot-tutorial-popup-content" id="carrot-tutorial-popup-content">
                        <!-- Tutorial content -->
                    </div>
                    <div class="carrot-tutorial-popup-nav">
                        <button class="carrot-tutorial-prev" id="carrot-tutorial-prev" onclick="CarrotKernel.previousTutorialStep()">
                            <i class="fa-solid fa-arrow-left"></i> Previous
                        </button>
                        <span class="carrot-tutorial-progress" id="carrot-tutorial-progress">1 / 5</span>
                        <button class="carrot-tutorial-next" id="carrot-tutorial-next" onclick="CarrotKernel.nextTutorialStep()">
                            Next <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- RAG Chunk Visualizer Modal -->
            <div id="carrot-rag-visualizer-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--SmartThemeBlurTintColor, rgba(0,0,0,0.85)); z-index: 10000; overflow-y: auto;">
                <div style="max-width: 1200px; margin: 50px auto; background: var(--SmartThemeBodyColor, #1e293b); border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); padding: 0; position: relative; border: 1px solid var(--SmartThemeBorderColor, rgba(255,255,255,0.1));">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, color-mix(in srgb, var(--SmartThemeBodyColor, #1e293b) 80%, var(--SmartThemeQuoteColor, #10b981) 20%), var(--SmartThemeBodyColor, #1e293b)); padding: 24px 30px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--SmartThemeBorderColor, rgba(255,255,255,0.1));">
                        <div>
                            <h2 id="carrot-rag-modal-title" style="margin: 0; color: var(--SmartThemeEmColor, white); font-size: 1.5em; font-weight: 700;">
                                <i class="fa-solid fa-cube"></i> Chunk Visualizer
                            </h2>
                            <p id="carrot-rag-modal-subtitle" style="margin: 5px 0 0 0; color: var(--SmartThemeEmColor, rgba(255,255,255,0.9)); font-size: 0.95em; opacity: 0.9;"></p>
                        </div>
                        <button id="carrot-rag-modal-close" style="background: rgba(255,255,255,0.2); border: none; color: var(--SmartThemeEmColor, white); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2em; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>

                    <!-- Search and Stats Bar -->
                    <div style="padding: 20px 30px; background: var(--black30a, rgba(0,0,0,0.3)); border-bottom: 1px solid var(--SmartThemeBorderColor, rgba(255,255,255,0.1));">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="carrot-rag-chunk-search" placeholder="üîç Search chunks..." style="flex: 1; min-width: 250px; padding: 10px 15px; background: var(--black30a, rgba(0,0,0,0.3)); border: 1px solid var(--SmartThemeBorderColor, rgba(255,255,255,0.2)); border-radius: 6px; color: var(--SmartThemeEmColor, white); font-size: 0.95em;">
                            <div id="carrot-rag-chunk-stats" style="display: flex; gap: 20px; color: var(--grey70, #94a3b8); font-size: 0.9em;">
                                <!-- Stats will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Chunks Container -->
                    <div id="carrot-rag-chunks-container" style="padding: 30px; max-height: 70vh; overflow-y: auto; background: var(--SmartThemeBodyColor, #1e293b);">
                        <!-- Chunks will be populated here -->
                    </div>

                    <!-- Footer Actions -->
                    <div style="padding: 20px 30px; background: var(--black30a, rgba(0,0,0,0.3)); border-top: 1px solid var(--SmartThemeBorderColor, rgba(255,255,255,0.1)); border-radius: 0 0 12px 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: var(--grey70, #94a3b8); font-size: 0.9em;">
                            <i class="fa-solid fa-info-circle"></i> Click any chunk to edit, or delete unwanted chunks
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="carrot-rag-modal-save" class="carrot-primary-btn" style="padding: 10px 20px;">
                                <i class="fa-solid fa-save"></i> Save Changes
                            </button>
                            <button id="carrot-rag-modal-cancel" class="carrot-secondary-btn" style="padding: 10px 20px;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            </div>
        </div>
    </div>
</div>



